import os
import fitz  # PyMuPDF
import pandas as pd

# Function to check if a checkbox is checked
def is_checked(widget):
    # Check if the widget is checked based on its field flags
    return widget.field_flags & fitz.PDF_WIDGET_FLAG_CHECKED

# Function to extract product statuses
def extract_product_status(doc, product_names):
    status = {}
    for page in doc:
        for widget in page.widgets():
            if any(product in widget.field_value for product in product_names):
                # Check the product and determine if it's checked
                for product in product_names:
                    if product in widget.field_value:
                        status[product] = "Yes" if is_checked(widget) else "No"
    return status

# List all PDF files
pdf_files = [f for f in os.listdir('.') if f.endswith('.pdf')]
data = []

# Read each PDF and extract the required information
for file_name in pdf_files:
    with fitz.open(file_name) as doc:
        products_status = extract_product_status(doc, ["Products", "ECH", "PDC"])
        parts = file_name.replace('.pdf', '').split('---')
        if len(parts) >= 4:
            document_date = parts[2]
            customer_name = parts[3].replace('-', ' ')
            tax_id = parts[4]
            data.append({
                "Document Date": document_date,
                "Customer Name": customer_name,
                "Tax ID": tax_id,
                "BSA Product": products_status.get("Products", "No"),
                "ECH": products_status.get("ECH", "No"),
                "PDC": products_status.get("PDC", "No")
            })

# Convert to DataFrame
df = pd.DataFrame(data)
import ace_tools as tools; tools.display_dataframe_to_user(name="Extracted PDF Details", dataframe=df)
